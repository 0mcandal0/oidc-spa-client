<html>
<body>
  <h1>Hello</h1>
  <h2><div id="info">...</div></h2>
  <div id="at" style="margin:20px"></div>
  <div id="result" style="margin:20px">foo</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/oidc-client/1.8.2/oidc-client.min.js"></script>
  <script>
  const config = {
    authority: 'https://demo.identityserver.io/',
    client_id: 'spa',
    redirect_uri: 'http://localhost:8080/callback.html',
    popup_post_logout_redirect_uri: 'http://localhost:8080/logout.html',
    response_type: 'code',
    scope: 'openid profile email api offline_access'
  };

  const manager = new Oidc.UserManager(config);

  async function getData(user) {
    const tokenElem = document.getElementById('at');
    tokenElem.innerText = user.access_token;

    const button = document.createElement('button');
    button.type = 'button';
    button.innerText = 'logout';
    button.style = 'width: 100px; height: 20px';
    button.onclick = logout;

    tokenElem.appendChild(button);

    // call the API
    const response = await fetch('https://localhost:6001/api/secure', {
      headers:{
        'Authorization': 'Bearer ' + user.access_token
      }
    });

    const data = await response.text();
    const resultElem = document.getElementById('result');
    resultElem.innerText = data;
  }

  async function getToken() {

    const user = await manager.getUser();

    if (!user) {
      const elem = document.getElementById('info');
      elem.innerText = 'Redirecting in 3s...';

      setTimeout(async () => {
        try {
          const result = await manager.signinPopup();
          // notify everyone we got a result
          getData(result);
        } catch (error) {
          console.log(error);
        }
      }, 3000);
    }
    else {
      getData(user);
    }
  }

  async function logout() {
    var result = await manager.signoutPopup();
    document.location.reload(true);
  }

  getToken();

</script>
</body>
</html>
